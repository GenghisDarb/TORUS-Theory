%% Auto-patch: missing macros & safer compile
\ProvidesFile{torus_book_preamble_patch}[2025/06/02 TORUS ad-hoc fixes]

% ---- 1. macros that were undefined ----------------------
\newcommand{\LambdaCDM}{\ensuremath{\Lambda\text{CDM}}}
\newcommand{\LCDM}{\LambdaCDM} % alias if used elsewhere

% ---- 2. show deeper error context -----------------------
\errorcontextlines=100

% ---- 3. ad-hoc fixes for DOCX conversion artifacts ----
\newcommand{\hbarc}{\hbar c}
\newcommand{\textless}{<}
\newcommand{\textgreater}{>}
\newcommand{\textless/sub}{\ensuremath{_{<}}}
\newcommand{\textgreater/sub}{\ensuremath{_{>}}}

% ---- 4. more ad-hoc fixes for undefined macros ----
\newcommand{\Lambdarec}{\Lambda_{\mathrm{rec}}}
\newcommand{\real}[1]{\mathrm{Re}\left(#1\right)}

% ---- 5. Unicode and font support for XeLaTeX ----
\usepackage{fontspec}
\usepackage{unicode-math}
\setmainfont{Latin Modern Roman}
\setmathfont{Latin Modern Math}

% ---- 6. Additional robust error surfacing ----
% Show all undefined references and citations as errors
\AtEndDocument{%
  \if@filesw\immediate\write\@mainaux{\string\@input{\jobname.aux}}\fi
  \ifx\@undefined\undefined\errmessage{Undefined macro found!}\fi
}

% Optionally, force fatal error on undefined control sequence (for CI)
% \makeatletter
% \def\@undefined#1{\errmessage{Undefined control sequence: #1}}
% \makeatother

% ---- 7. Add any further missing macros or fixes below ----
